# 交付物2：核心数据流图

## 1. 系统级数据流总览

### 1.1 整体架构数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心数据流总图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────────────┐
   │                          用户交互域                                       │
   │                                                                         │
   │    睡前准备 ──► 睡眠阶段 ──► 梦境学习 ──► 醒后复盘                        │
   │       │           │            │            │                           │
   │       ▼           ▼            ▼            ▼                           │
   │    选择内容   实时监测    情境呈现    生成报告                            │
   │    设置强度   分期判定    简单交互    巩固卡片                            │
   │    启动监测   REM等待    记忆编码    遗忘提醒                            │
   └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
   ┌─────────────────────────────────────────────────────────────────────────┐
   │                           感知层数据采集                                  │
   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
   │   │   EEG    │  │   EOG    │  │   ECG    │  │  辅助    │             │
   │   │  16ch@256Hz    │  │  4ch@128Hz    │  │  3ch@250Hz    │  │  传感器 │             │
   │   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
   │        └────────────┼────────────┼────────────┘                        │
   │                      │                                                    │
   │                      ▼                                                    │
   │              ┌────────────────┐                                          │
   │              │   信号预处理   │                                          │
   │              │ (滤波/去噪/ICA) │                                          │
   │              └───────┬────────┘                                          │
   └──────────────────────┼───────────────────────────────────────────────────┘
                          │
                          ▼
   ┌─────────────────────────────────────────────────────────────────────────┐
   │                          计算层核心处理                                   │
   │                                                                         │
   │   ┌──────────────────────────────────────────────────────────────────┐  │
   │   │                    睡眠分期引擎                                  │  │
   │   │  EEG/EOG/ECG ──► 特征提取 ──► CNN-LSTM ──► W/N1/N2/N3/REM     │  │
   │   └──────────────────────────────────────────────────────────────────┘  │
   │                                    │                                     │
   │                                    ▼                                     │
   │   ┌──────────────────────────────────────────────────────────────────┐  │
   │   │                    REM窗口预测器                                 │  │
   │   │   睡眠历史 + 当前状态 ──► Transformer ──► REM窗口预测           │  │
   │   └──────────────────────────────────────────────────────────────────┘  │
   │                                    │                                     │
   │                                    ▼ 触发信号                             │
   │   ┌──────────────────────────────────────────────────────────────────┐  │
   │   │                    诱导策略决策引擎                              │  │
   │   │         规则引擎 + ML混合决策 ──► 诱导指令集                    │  │
   │   └──────────────────────────────────────────────────────────────────┘  │
   └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
   ┌─────────────────────────────────────────────────────────────────────────┐
   │                        交互/诱导层输出                                    │
   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
   │   │ 弱光控制 │  │ 声学控制 │  │ 振动控制 │  │ 香氛控制 │             │
   │   │  LED    │  │  Audio   │  │ Haptic   │  │  Scent   │             │
   │   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
   │        └────────────┼────────────┼────────────┘                      │
   │                      │                                                    │
   │                      ▼                                                    │
   │              ╔════════════════════════════════════╗                      │
   │              ║           梦境空间                  ║                      │
   │              ║   历史场景/语言对话/考点卡片/技能流程  ║                      │
   │              ╚════════════════════════════════════╝                      │
   └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
   ┌─────────────────────────────────────────────────────────────────────────┐
   │                          醒后处理域                                       │
   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
   │   │ 学习报告 │  │ 巩固卡片 │  │ 遗忘提醒 │  │ 模型迭代 │             │
   │   │   生成   │  │   生成   │  │   调度   │  │   更新   │             │
   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘             │
   └─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 睡眠分期数据流（详细）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      睡眠分期数据流 DETAILED                                   │
└─────────────────────────────────────────────────────────────────────────────┘

原始信号采集 ────────────────────────────────────────────────────────────────
     │
     │  EEG: 16ch@256Hz    EOG: 4ch@128Hz    ECG: 3ch@250Hz
     │
     └─────────────────────────┼───────────────────────────┘
                                │
                                ▼
信号预处理模块 ─────────────────────────────────────────────────────────────
  1. 带通滤波 (EEG: 0.5-30Hz, EOG: 0.1-10Hz, ECG: 0.5-45Hz)
  2. 工频滤波 (50Hz/60Hz)
  3. 眼电伪迹去除 (ICA/PCA)
  4. 运动伪迹检测与标记
  5. 信号质量评分
                                │
                                ▼
特征提取模块 ───────────────────────────────────────────────────────────────
  ┌─────────────────────────────────────────────────────────────────────┐
  │  频带功率        │  眼动特征          │  HRV特征                    │
  │  Delta (0.5-4Hz) │  幅度              │  SDNN                       │
  │  Theta (4-8Hz)   │  频率              │  RMSSD                      │
  │  Alpha (8-13Hz)  │  方向              │  LF/HF比                    │
  │  Beta (13-30Hz)  │                    │                            │
  │  Gamma (30-100Hz)│                    │                            │
  └─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
CNN-LSTM分类器 ───────────────────────────────────────────────────────────
                                │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
           [Wake]          [NREM]           [REM]
             │                │                │
             │     ┌─────────┼─────────┐      │
             │     │ N1      │ N2      │ N3  │
             │     └─────────┴─────────┘      │
              │                              │
              └──────────────────────────────┘
                                │
                                ▼
输出结果 ─────────────────────────────────────────────────────────────────
  {
    "timestamp": "2026-02-09T13:42:00Z",
    "stage": "N2",           // Wake/N1/N2/N3/REM
    "confidence": 0.87,      // 0.0-1.0
    "probabilities": {
      "W": 0.02, "N1": 0.05, "N2": 0.87, "N3": 0.04, "REM": 0.02
    },
    "quality_score": 0.92    // 信号质量评分
  }
```

---

## 3. REM触发与诱导数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    REM触发与多模态诱导数据流                                   │
└─────────────────────────────────────────────────────────────────────────────┘

REM窗口触发条件 ────────────────────────────────────────────────────────────
  1. 实时分期检测到 REM（置信度>0.8）
  2. 预测模型预估REM窗口（概率>0.7）
  3. 人工干预指令（紧急唤醒/停止）
                                │
                                ▼
诱导策略决策引擎 ──────────────────────────────────────────────────────────
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
   ┌──────────┐            ┌──────────┐            ┌──────────┐
   │诱导方案   │            │内容匹配   │            │强度调节   │
   │选择器     │            │路由器     │            │控制器    │
   └────┬─────┘            └────┬─────┘            └────┬─────┘
        │                       │                      │
        └───────────────────────┼──────────────────────┘
                                │
                                ▼
诱导参数生成 ───────────────────────────────────────────────────────────────
  {
    "audio": {
      "type": "theta_beat",
      "frequency": 6.0,      // Hz
      "modulation": "AM",
      "volume_db": -20,
      "duration_sec": 300
    },
    "visual": {
      "wavelength": 530,     // nm (绿光)
      "brightness_lux": 3,
      "pulse_freq": 0.5,
      "pattern": "breathing"
    },
    "haptic": {
      "frequency": 0.5,
      "amplitude": 0.3,
      "pattern": "pulse"
    },
    "scent": {
      "formula": "lavender",
      "concentration": 50,
      "duration_sec": 1800
    }
  }
                                │
                                ▼
多模态诱导执行器 ──────────────────────────────────────────────────────────
  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
  │   声学诱导   │  │   视觉诱导   │  │   触觉诱导   │  │   嗅觉诱导   │
  │              │  │              │  │              │  │              │
  │ 蓝牙/音箱    │  │ 眼罩/LED阵列 │  │ 振动马达    │  │ 香薰机      │
  │ Theta音频    │  │ 530nm绿光    │  │ 0.5Hz脉冲   │  │ 薰衣草精油   │
  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
                                │
                                ▼
内容神经编码注入 ─────────────────────────────────────────────────────────
  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐
  │   场景叙事注入器    │  │   记忆锚点编码器    │  │   交互指令生成器    │
  └────────────────────┘  └────────────────────┘  └────────────────────┘
                                │
                                ▼
梦境空间呈现（用户感知）────────────────────────────────────────────────────
  • 视觉：模糊的场景画面、关键人物/物品
  • 听觉：相关声音（对话、环境音）、关键词汇
  • 触觉：轻度振动反馈
  • 嗅觉：情境相关气味
  • 情感：与内容匹配的情绪基调
```

---

## 4. 醒后数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          醒后复盘数据流                                       │
└─────────────────────────────────────────────────────────────────────────────┘

用户苏醒触发 ───────────────────────────────────────────────────────────────
                                │
                                ▼
睡眠数据聚合 ─────────────────────────────────────────────────────────────
  {
    "session_id": "session_20260209_001",
    "sleep_period": {
      "start": "2026-02-09T23:00:00Z",
      "end": "2026-02-10T07:00:00Z",
      "total_duration_sec": 28800,
      "efficiency": 0.85
    },
    "rem_cycles": [
      {"start": "00:30:00", "duration": 480},
      {"start": "02:00:00", "duration": 720},
      {"start": "03:30:00", "duration": 900},
      {"start": "05:15:00", "duration": 1080}
    ],
    "induction_events": [
      {"timestamp": "...", "type": "audio", "content_id": "..."}
    ]
  }
                                │
                                ▼
学习效果评估 ─────────────────────────────────────────────────────────────
  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
  │    客观指标      │  │    主观指标      │  │    对比基线      │
  │                  │  │                  │  │                  │
  │ • REM利用率      │  │ • 梦境清晰度    │  │ • vs 传统学习    │
  │ • 诱导响应率     │  │ • 内容相关性    │  │ • vs 无干预      │
  │ • 学习效率       │  │ • 主观满意度    │  │                  │
  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
           │                      │                      │
           └──────────────────────┼──────────────────────┘
                                  │
                                  ▼
                          ┌────────────────┐
                          │   综合评分     │
                          │   (0.0-1.0)   │
                          └────────────────┘
                                  │
                                  ▼
输出物生成 ─────────────────────────────────────────────────────────────────
           ┌─────────────────────────────┐
           │       学习报告卡片           │
           │   ┌─────────────────────┐   │
           │   │ 睡眠质量：★★★★☆   │   │
           │   │ REM利用率：85%     │   │
           │   │ 诱导效果：优秀     │   │
           │   │ 梦境清晰度：高     │   │
           │   │                     │   │
           │   │ 学习内容回顾：      │   │
           │   │ 安史之乱 · 核心     │   │
           │   └─────────────────────┘   │
           └──────────────┬──────────────┘
                          │
                          ▼
           ┌─────────────────────────────┐
           │       记忆巩固卡片           │
           │   ┌─────────────────────┐   │
           │   │ 🎯 今日记忆点        │   │
           │   │                     │   │
           │   │ 1. 安禄山范阳起兵   │   │
           │   │    755年11月        │   │
           │   │                     │   │
           │   │ 2. 玄宗仓皇出逃     │   │
           │   │    马嵬驿兵变       │   │
           │   │                     │   │
           │   │ 3. 知识点关联：     │   │
           │   │    藩镇割据 ←→     │   │
           │   │    安史之乱         │   │
           │   └─────────────────────┘   │
           └──────────────┬──────────────┘
                          │
                          ▼
           ┌─────────────────────────────┐
           │       遗忘曲线提醒           │
           │   ┌─────────────────────┐   │
           │   │ 下次复习建议：       │   │
           │   │                     │   │
           │   │ • 24小时内：短复习   │   │
           │   │ • 3天后：中度复习   │   │
           │   │ • 7天后：巩固复习   │   │
           │   └─────────────────────┘   │
           └──────────────┬──────────────┘
                          │
                          ▼
           ┌─────────────────────────────┐
           │       个性化模型迭代         │
           │                             │
           │   用户反馈 ──► 效果评估     │
           │       │           │         │
           │       ▼           ▼         │
           │   记忆效果    学习效率       │
           │   主观评价    客观指标       │
           │       │           │         │
           │       └───────────┘         │
           │             │               │
           │             ▼               │
           │   诱导参数 + 内容难度优化     │
           └─────────────────────────────┘
```

---

## 5. 跨层数据流汇总

### 5.1 实时数据流（延迟敏感）

| 数据流 | 源模块 | 目标模块 | 延迟要求 | 频率 |
|-------|--------|---------|---------|------|
| 原始EEG | 感知层 | 计算层 | <50ms | 256Hz |
| 睡眠分期 | 计算层 | 决策引擎 | <100ms | 1Hz |
| 诱导指令 | 决策引擎 | 诱导执行器 | <200ms | 事件驱动 |

### 5.2 批处理数据流（延迟容忍）

| 数据流 | 源模块 | 目标模块 | 延迟要求 | 触发条件 |
|-------|--------|---------|---------|---------|
| 学习报告 | 醒后系统 | 用户APP | <30s | 用户苏醒 |
| 巩固卡片 | 醒后系统 | 用户APP | <60s | 报告生成 |
| 模型迭代 | 个性化AI | 云端训练 | <24h | 每日批量 |
| 内容更新 | 内容层 | 边缘设备 | <1h | 新版本发布 |

---

*文档版本：v1.0*  
*作者：造梦府系统架构组*  
*最后更新：2026-02-09*
