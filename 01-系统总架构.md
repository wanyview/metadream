# 交付物1：系统总架构

## 1. 系统架构总览

造梦府DreamLearn采用**四层分布式架构**，从底向上依次为感知层、计算层、交互/诱导层、内容层。数据在各层之间单向流动，控制信号逆向反馈。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              【四层架构结构树】                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    第四层：内容层 (Content Layer)                    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │    │
│  │  │ 历史沉浸引擎 │ │ 语言情境系统 │ │ 考点速记库  │ │ 技能流程库  │   │    │
│  │  │             │ │             │ │             │ │             │   │    │
│  │  │ 安史之乱场景 │ │ 雅思/托福   │ │ 中考/高考   │ │ 钢琴指法    │   │    │
│  │  │ 文艺复兴     │ │ 商务英语    │ │ 考研政治    │ │ 外科技法    │   │    │
│  │  │ 火星探测     │ │ 西班牙语    │ │ 司法考试    │ │ 驾驶训练    │   │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                 第三层：交互/诱导层 (Induction Layer)                 │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │    │
│  │  │ 弱光诱导模块 │ │ 声学诱导模块 │ │ 振动诱导模块 │ │ 香氛诱导模块 │   │    │
│  │  │             │ │             │ │             │ │             │   │    │
│  │  │ LED阵列控制 │ │ 白噪音/ASMR │ │ 触觉反馈    │ │ 嗅觉刺激    │   │    │
│  │  │ 波长: 530nm │ │ 4-40Hz调制  │ │ 0.5-2Hz     │ │ 精油配方    │   │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    第二层：计算层 (Computation Layer)                │    │
│  │                                                                      │    │
│  │   ┌──────────────────────────────┐  ┌──────────────────────────────┐│    │
│  │   │       边缘AI子系统           │  │       云端AI子系统           ││    │
│  │   │                              │  │                              ││    │
│  │   │ ┌────────────────────────┐  │  │ ┌────────────────────────┐  ││    │
│  │   │ │ 实时睡眠分期算法       │  │  │ │ 大语言模型生成         │  ││    │
│  │   │ │ (CNN-LSTM混合架构)     │  │  │ │ (DreamNarrative GPT)    │  ││    │
│  │   │ └────────────────────────┘  │  │ └────────────────────────┘  ││    │
│  │   │                              │  │                              ││    │
│  │   │ ┌────────────────────────┐  │  │ ┌────────────────────────┐  ││    │
│  │   │ │ REM窗口预测模型       │  │  │ │ 个性化推荐引擎         │  ││    │
│  │   │ │ (Transformer时序模型) │  │  │ │ (Reinforcement Learning)│ ││    │
│  │   │ └────────────────────────┘  │  │ └────────────────────────┘  ││    │
│  │   │                              │  │                              ││    │
│  │   │ ┌────────────────────────┐  │  │ ┌────────────────────────┐  ││    │
│  │   │ │ 诱导策略实时决策       │  │  │ │ 长期学习效果分析       │  ││    │
│  │   │ │ (Rule-based + ML)      │  │  │ │ (Analytics Dashboard)   │  ││    │
│  │   │ └────────────────────────┘  │  │ └────────────────────────┘  ││    │
│  │   └──────────────────────────────┘  └──────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    第一层：感知层 (Perception Layer)                  │    │
│  │                                                                      │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │ EEG采集模块  │  │ EOG采集模块  │  │ ECG采集模块  │  │ 辅助传感器  │ │    │
│  │  │             │  │             │  │             │  │             │ │    │
│  │  │ 干电极方案   │  │ 红外/角膜   │  │ 3导联方案    │  │ 呼吸/体温   │ │    │
│  │  │ 8-16通道    │  │ 4导联       │  │ 250Hz采样    │  │ 血氧/体动   │ │    │
│  │  │ 256Hz采样   │  │ 采样率待定  │  │             │  │             │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐   │    │
│  │  │                    睡眠分期算法引擎                          │   │    │
│  │  │                                                                │   │    │
│  │  │   输入信号 ──► 预处理 ──► 特征提取 ──► 分类器 ──► 睡眠阶段   │   │    │
│  │  │                              │                               │   │    │
│  │  │                              ▼                               │   │    │
│  │  │                    Wake / N1 / N2 / N3 / REM                 │   │    │
│  │  └───────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 各层详细说明

### 2.1 第一层：感知层（Perception Layer）

**核心职责**：生物信号采集、睡眠阶段实时判定

#### 2.1.1 硬件规格

| 传感器类型 | 通道数 | 采样率 | 电极方案 | 功耗 |
|-----------|--------|--------|---------|------|
| EEG | 8-16通道 | 256Hz | 干电极（Connor/Gel可选） | <500mW |
| EOG | 4导联 | 128Hz | 银/氯化银湿电极 | <100mW |
| ECG | 3导联 | 250Hz | 银/氯化银湿电极 | <50mW |
| 辅助 | 4类 | 32Hz | 压电/光学 | <50mW |

**硬件供应商备选**：
- EEG方案：Emotiv EPOC X（14通道）、Muse 2（4通道）、OpenBCI（16通道）
- 一体化方案：NeuroScan、ANT Neuro

#### 2.1.2 睡眠分期算法

```python
# 伪代码：睡眠分期流程
class SleepStagingEngine:
    def __init__(self):
        self.preprocessor = SignalPreprocessor()
        self.feature_extractor = EEGFeatureExtractor()
        self.classifier = CNN_LSTM_Hybrid()
    
    def process(self, eeg_signal, eog_signal, ecg_signal):
        # 1. 信号预处理
        cleaned_eeg = self.preprocessor.filter(eeg_signal, freq_range=[0.5, 30])
        cleaned_eog = self.preprocessor.filter(eog_signal, freq_range=[0.5, 10])
        cleaned_ecg = self.preprocessor.denoise(ecg_signal)
        
        # 2. 特征提取
        features = self.feature_extractor.extract(
            eeg=cleaned_eeg,
            eog=cleaned_eog,
            ecg=cleaned_ecg,
            # 提取特征包括：
            # - 频带功率（delta/theta/alpha/beta/gamma）
            # - 眼动幅度与频率
            # - 心率变异性（HRV）
            # - 肌电活动（若可用）
        )
        
        # 3. 分类输出
        sleep_stage = self.classifier.predict(features)  # W/N1/N2/N3/REM
        confidence = self.classifier.confidence(features)
        
        return {
            "stage": sleep_stage,
            "confidence": confidence,
            "timestamp": current_time()
        }
```

**分期准确率目标**：>85%（与人工标注PSG对比）

#### 2.1.3 REM窗口预测

```python
# REM窗口预测模型（基于历史睡眠结构）
class REM Predictor:
    def __init__(self):
        self.model = TransformerTimeSeries()
        self.rem_cycle_duration = 90  # 分钟，平均REM周期
        self.rem_length_stats = {  # 各REM周期典型时长
            "first": 5-10,
            "second": 10-20,
            "third": 20-40,
            "fourth+": 30-60
        }
    
    def predict_rem_windows(self, sleep_history, current_stage):
        """
        基于已完成的睡眠周期，预测后续REM窗口
        返回：[(start_time, end_time, probability), ...]
        """
        pass
```

---

### 2.2 第二层：计算层（Computation Layer）

**核心职责**：AI推理、决策优化、数据分析

#### 2.2.1 边缘AI子系统

| 功能模块 | 模型架构 | 推理延迟 | 运行平台 |
|---------|---------|---------|---------|
| 实时睡眠分期 | CNN-LSTM | <100ms | 边缘盒子（Raspberry Pi 5/ Jetson Nano） |
| REM窗口预测 | Transformer | <500ms | 边缘盒子 |
| 诱导策略决策 | Rule-based + 轻量ML | <200ms | 边缘盒子 |
| 实时信号质量检测 | 1D-CNN | <50ms | 边缘盒子 |

**边缘设备规格**：
- 最低配置：Raspberry Pi 5 + NPU加速棒
- 推荐配置：Jetson Nano + 8GB RAM
- 功耗：5-15W（可电池供电）

#### 2.2.2 云端AI子系统

| 功能模块 | 模型架构 | 响应时间 | 服务模式 |
|---------|---------|---------|---------|
| 梦境叙事生成 | DreamNarrative GPT-4 | 2-5s | REST API |
| 个性化推荐 | RL推荐系统 | 1-3s | 实时计算 |
| 长期学习分析 | Analytics Engine | 10-30s | 批处理 |
| 内容质量控制 | 多模态审核模型 | 实时 | 流式处理 |

**云端架构**：
- Kubernetes集群（AWS/Azure/阿里云）
- GPU实例用于大模型推理
- 数据湖存储用户学习数据

---

### 2.3 第三层：交互/诱导层（Induction Layer）

**核心职责**：多模态刺激信号生成与输出

#### 2.3.1 诱导模块规格

| 模态 | 设备类型 | 信号参数 | 安全阈值 |
|-----|---------|---------|---------|
| 视觉 | 床周LED阵列 / 眼罩内嵌微LED | 530nm绿光、亮度<5 lux、脉冲频率1-10Hz | 亮度<10 lux，避免惊醒 |
| 听觉 | 蓝牙耳机 / 床周音箱 | 白噪音/粉红噪音、4-40Hz调制、音量<40dB | <50dB，避免REM干扰 |
| 触觉 | 振动马达 / 触觉背心 | 0.5-2Hz脉冲、振幅可调 | 振幅<阈值，避免唤醒 |
| 嗅觉 | 香薰机 / 可穿戴嗅贴 | 薰衣草/迷迭香精油配方 | 浓度<100ppm |

#### 2.3.2 诱导协议

**MILD方案（Memory Incubation of Lucid Dreams）**：

```
时间线（以入睡后90分钟为例）：

T-30min: 睡前暗示阶段
├── 用户选择学习内容
├── 系统生成暗示音频（"我会在梦中见到XXX场景"）
└── 用户聆听3-5分钟

T-20min: 设备准备
├── EEG/EOG传感器连接
├── 基线信号采集
└── 边缘AI启动监测

T-15min: 入睡准备
├── 弱光诱导启动（530nm，0.5Hz）
└── 白噪音诱导启动（15Hz调制）

T+0min: 入睡
├── 睡眠分期持续监测
└── 等待第一个REM周期

T+90min: 第一个REM窗口
├── 声学诱导加强（25Hz theta波音频）
├── 视觉诱导启动（微光脉冲）
└── 内容神经编码信号注入
```

---

### 2.4 第四层：内容层（Content Layer）

**核心职责**：学习内容管理、神经编码转换

#### 2.4.1 内容类型

| 类型 | 示例 | 编码方式 | 适用场景 |
|-----|------|---------|---------|
| 历史沉浸 | 安史之乱场景还原 | 场景叙事+关键人物+事件节点 | 睡前预习/复习 |
| 语言情境 | 雅思口语场景模拟 | 对话脚本+发音提示+语法点 | 词汇/口语训练 |
| 考点速记 | 中考数学公式 | 视觉化呈现+口诀编码 | 考前突击 |
| 技能流程 | 钢琴指法/外科手术 | 步骤分解+肌肉记忆强化 | 技能习得 |

#### 2.4.2 内容生产工作流

```
内容需求 ──► 专家编写 ──► 科学审核 ──► 神经编码 ──► 试点测试 ──► 上线发布
             │           │            │            │
             ▼           ▼            ▼            ▼
          文本/脚本   准确性验证   信号映射      用户反馈迭代
```

---

## 3. 模块间接口规范

### 3.1 层间通信协议

| 接口编号 | 连接层 | 协议 | 数据格式 | 频率 |
|---------|-------|------|---------|------|
| I01 | 感知→计算 | WebSocket/USB | JSON+Binary | 256Hz（原始信号） / 1Hz（分期结果） |
| I02 | 计算→诱导 | MQTT | JSON | 事件驱动（REM触发时） |
| I03 | 计算→内容 | REST API | JSON | 请求-响应 |
| I04 | 内容→诱导 | WebSocket | JSON+Audio | 实时流 |

### 3.2 数据格式标准

```json
// REM窗口触发信号（I02接口）
{
  "event_type": "rem_window_detected",
  "timestamp": "2026-02-09T13:42:00.000Z",
  "rem_probability": 0.92,
  "window_duration_estimate": 1800,
  "recommended_induction": "mild_plus_audio",
  "content_id": "hist_anlush_01",
  "intensity_level": 3
}

// 内容神经编码指令（I04接口）
{
  "content_type": "historical_immersion",
  "scene_id": "anlush_battle_01",
  "narrative_segments": [
    {
      "timestamp_offset": 0,
      "audio_cue": "battle_drums.mp3",
      "visual_cue": {"color": "red", "pulse_freq": 2.0},
      "text_prompt": "你站在长安城头，看到远处狼烟升起..."
    }
  ],
  "memory_cues": ["安禄山", "范阳", "755年"]
}
```

---

## 4. 系统扩展性设计

### 4.1 硬件扩展接口

```
┌─────────────────────────────────────────┐
│         硬件抽象层（HAL）                 │
├─────────────────────────────────────────┤
│  EEG抽象接口 │ EOG抽象接口 │ ECG抽象接口 │
│       │            │            │        │
│       ▼            ▼            ▼        │
│  ┌─────────────────────────────────────┐ │
│  │      设备驱动适配层（Plugin）        │ │
│  │  ┌─────────┐  ┌─────────┐ ┌──────┐│ │
│  │  │ Emotiv  │  │ OpenBCI │ │Muse 2││ │
│  │  │ Driver  │  │ Driver  │ │Driver││ │
│  │  └─────────┘  └─────────┘ └──────┘│ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 4.2 软件模块化

- **微服务架构**：各功能模块独立部署
- **容器化**：Docker/Kubernetes
- **API网关**：统一入口、认证、限流

---

## 5. 部署架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户侧（边缘部署）                           │
│                                                                      │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │ 头戴设备  │   │ 诱导硬件  │   │ 边缘计算  │   │  手机App  │        │
│  │(EEG/EOG) │   │(光/声/触) │   │(RPi/Jetson)│  │(用户界面) │        │
│  └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│       │              │              │              │               │
│       └──────────────┴──────────────┴──────────────┘               │
│                              │                                     │
│                         local WiFi/BT                               │
└──────────────────────────────┼─────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          云端部署（远程）                             │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      DMZ层（API网关）                         │   │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│  │   │ Auth     │  │ RateLimit│  │ Logging  │  │ API Docs │  │   │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     业务服务层                                 │   │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │   │ 用户服务  │  │ 内容服务  │  │ 学习服务  │  │ 设备服务 │   │   │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     AI服务层                                  │   │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │   │ 睡眠AI   │  │ 梦境AI   │  │ 推荐AI   │  │ 分析AI   │   │   │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     数据层                                    │   │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │   │ 时序DB   │  │ 对象存储  │  │ 数据湖   │  │ 缓存     │   │   │
│  │   │(InfluxDB)│  │ (S3/OSS) │  │(Delta Lake)│ │(Redis)  │   │   │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 安全与可靠性

### 6.1 安全措施

| 层级 | 措施 |
|-----|------|
| 传输层 | TLS 1.3、mTLS（服务间） |
| 应用层 | OAuth 2.0、JWT、双因素认证 |
| 数据层 | AES-256加密、字段级加密 |
| 边缘层 | TEE可信执行环境、安全启动 |

### 6.2 可靠性指标

| 指标 | 目标值 |
|-----|-------|
| 系统可用性 | 99.9% |
| 边缘AI响应延迟 | <500ms（p99） |
| 云端API响应时间 | <200ms（p95） |
| 数据丢失率 | <0.01% |
| 误唤醒率（睡眠中） | <1% |

---

*文档版本：v1.0*  
*作者：造梦府系统架构组*  
*最后更新：2026-02-09*
